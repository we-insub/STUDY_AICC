<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.aicc.modules.mypage.repository.MypageMapper">

    <resultMap id="findProfileMap" type="kr.co.aicc.modules.mypage.dto.ProfileForm">
        <result property="memNo" column="MEM_NO" />
        <result property="memId" column="MEM_ID" />
        <result property="memIdF" column="MEM_ID_F" />
        <result property="memIdL" column="MEM_ID_L" />
        <result property="memNm" column="MEM_NM" />
        <result property="sex" column="SEX" />
        <result property="brthday" column="BRTHDAY" />
        <result property="ptblTelNo" column="PTBL_TEL_NO" />
        <result property="zipNo" column="ZIP_NO" />
        <result property="baseAddr" column="BASE_ADDR" />
        <result property="dtlAddr" column="DTL_ADDR" />
        <result property="lastEdu" column="LAST_EDU" />
        <result property="lastEduNm" column="LAST_EDU_NM" />
        <result property="useModel" column="USE_MODEL" />
        <result property="useModelNm" column="USE_MODEL_NM" />
        <result property="careerDesc" column="CAREER_DESC" />
        <result property="fileNm" column="FILE_NM" />
        <result property="sysFileNm" column="SYS_FILE_NM" />
        <result property="thumbSysFileNm" column="THUMB_SYS_FILE_NM" />
        <result property="filePath" column="FILE_PATH" />
    </resultMap>
    
	<select id="findProfileByMemNo" parameterType="kr.co.aicc.modules.mypage.dto.ProfileForm" resultMap="findProfileMap">
		SELECT /** mypage.findProfileByMemNo */
	           MEM_NO
			   , MEM_ID
			   , SPLIT_PART(MEM_ID,'@',1) AS MEM_ID_F
			   , SPLIT_PART(MEM_ID,'@',2) AS MEM_ID_L			   
			   , MEM_NM
			   , SEX
			   , BRTHDAY
			   , PTBL_TEL_NO
			   , ZIP_NO
			   , BASE_ADDR
			   , DTL_ADDR
			   , LAST_EDU
			   , COALESCE((SELECT CD_NM FROM TB_DTL_CD WHERE GRP_CD = 'EDU' AND CD = T1.LAST_EDU),'') AS LAST_EDU_NM
			   , USE_MODEL
			   , COALESCE((SELECT CD_NM FROM TB_DTL_CD WHERE GRP_CD = 'MODEL' AND CD = T1.USE_MODEL),'') AS USE_MODEL_NM
			   , CAREER_DESC
			   , FILE_NM
			   , SYS_FILE_NM
			   , THUMB_SYS_FILE_NM
			   , FILE_PATH
          FROM TB_MEM T1
         WHERE 1=1
		   AND T1.MEM_NO = #{memNo}
	</select>
	
	<!-- 회원정보 수정 -->
	<update id="updateProfile" parameterType="account">
		UPDATE /** mypage.updateProfile */
			   TB_MEM
		   SET	
			   MEM_NM = #{memNm}
			<if test = 'passwd != null and passwd != ""'>
			   , PASSWD = #{passwd}
			</if>
			   , SEX = #{sex}
			   , BRTHDAY = #{brthday}
			   , PTBL_TEL_NO = #{ptblTelNo}
			   , ZIP_NO = #{zipNo}
			   , BASE_ADDR = #{baseAddr}
			   , DTL_ADDR = #{dtlAddr}
			   , LAST_EDU = #{lastEdu}
			   , USE_MODEL = #{useModel}
			   , CAREER_DESC = #{careerDesc}
			<if test = 'passwd != null and passwd != ""'>
			   , LAST_PASSWD_CHG_DT = NOW()
			</if>
			   , PROF_IMG_DATA = #{profImgData}
			   , CHGR = #{memNo}
			   , CHG_DT = NOW()
		 WHERE MEM_NO = #{memNo}
	</update>

	<!-- 회원탈퇴 -->
	<update id="profileDelete" parameterType="account">
		UPDATE /** mypage.profileDelete */
			   TB_MEM
		   SET
			   STAT = #{stat}
			   , WDL_RSN_CD = #{wdlRsnCd}
			   , WDL_DT = NOW()
			   , CHGR = #{memNo}
			   , CHG_DT = NOW()
		 WHERE MEM_ID = #{memId}

	</update>   
</mapper>
